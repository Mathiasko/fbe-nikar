---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PricingTable from '../../components/PricingTable.astro';
import { useTranslations } from '../../i18n/utils';
import { fetchSheetAsCSV, parsePricingData, parseCateringData } from '../../lib/sheets';
import { samplePricingData } from '../../data/sample-pricing';

const lang = 'sk';
const t = useTranslations(lang);

// Try to fetch from Google Sheets, fall back to sample data
let pricingData = samplePricingData;

const sheetId = import.meta.env.PUBLIC_SHEETS_ID;
const sheetGid = import.meta.env.PUBLIC_SHEETS_GID || '0';
const cateringGid = import.meta.env.PUBLIC_SHEETS_GID_CATERING;

if (sheetId) {
  // Fetch rooms from first sheet
  const roomsData = await fetchSheetAsCSV(sheetId, sheetGid);
  if (roomsData.length > 0) {
    pricingData = parsePricingData(roomsData);
  }

  // Fetch catering from second sheet
  if (cateringGid) {
    const cateringData = await fetchSheetAsCSV(sheetId, cateringGid);
    if (cateringData.length > 0) {
      pricingData.catering = parseCateringData(cateringData);
    }
  }
}

// Prepare room data for table (with optional links)
const roomHeaders = ['Školiaca miestnosť', 'm²', 'Sedenie do "U"', 'Cena za jeden deň (8:00-17:00)*'];
const roomRows = pricingData.rooms.map(room => [
  { text: room.name, link: room.link },
  room.size,
  room.capacity,
  room.price
]);

// Prepare catering data for table
const cateringHeaders = ['Položka', 'Cena'];
const cateringRows = pricingData.catering.map(item => [item.item, item.price]);
---

<BaseLayout
  title={`${t('page.pricing.title')} | ${t('ui.siteName')}`}
  description={t('page.pricing.description')}
  lang={lang}
>
  <div class="pricing-page">
    <h1>{t('page.pricing.title')}</h1>
    <p class="pricing-intro">{t('pricing.intro')}</p>

    <PricingTable
      title={t('pricing.roomRentals')}
      headers={roomHeaders}
      rows={roomRows}
    />

    <PricingTable
      title={t('pricing.catering')}
      headers={cateringHeaders}
      rows={cateringRows}
    />

    <div class="pricing-disclaimer">
      <p>Všetky ceny sú uvedené bez DPH.</p>
      <p>* Cena za jeden deň platí v čase od 8:00 do 17:00 hod.<br />
      V prípade záujmu o využitie miestnosti v inom čase je možná individuálna dohoda.</p>
      <p class="pricing-year">Cenník platí pre rok 2026.</p>
    </div>
  </div>
</BaseLayout>

<style>
  .pricing-page {
    max-width: 900px;
    margin: 0 auto;
  }

  .pricing-intro {
    margin-bottom: 2rem;
    color: var(--color-text-light);
    font-size: 1.1rem;
  }

  .pricing-disclaimer {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--color-background-alt);
    border-radius: 4px;
    font-size: 0.9rem;
    color: var(--color-text-light);
  }

  .pricing-disclaimer p {
    margin-bottom: 0.75rem;
  }

  .pricing-disclaimer p:last-child {
    margin-bottom: 0;
  }

  .pricing-year {
    font-weight: 600;
    color: var(--color-text);
  }
</style>
