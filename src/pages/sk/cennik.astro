---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PricingTable from '../../components/PricingTable.astro';
import { useTranslations } from '../../i18n/utils';
import { fetchSheetAsCSV, parseRoomPrices, parseCateringData } from '../../lib/sheets';
import { getRoomPricingRows } from '../../data/room-pricing';

const lang = 'sk';
const t = useTranslations(lang);

// Fetch prices from Google Sheets
let roomPrices: Record<string, string> = {};
let cateringData: { item: string; price: string; unit: string }[] = [];

const sheetId = import.meta.env.PUBLIC_SHEETS_ID;
const roomPricesGid = import.meta.env.PUBLIC_SHEETS_GID || '0';
const cateringGid = import.meta.env.PUBLIC_SHEETS_GID_CATERING;

if (sheetId) {
  // Fetch room prices
  const pricesData = await fetchSheetAsCSV(sheetId, roomPricesGid);
  if (pricesData.length > 0) {
    roomPrices = parseRoomPrices(pricesData);
  }

  // Fetch catering prices
  if (cateringGid) {
    const cateringRaw = await fetchSheetAsCSV(sheetId, cateringGid);
    if (cateringRaw.length > 0) {
      cateringData = parseCateringData(cateringRaw);
    }
  }
}

// Get room rows with hardcoded info + fetched prices
const roomRows = getRoomPricingRows(lang, roomPrices);

// Prepare room data for table
const roomHeaders = ['Školiaca miestnosť', 'm²', 'Sedenie do "U"', 'Cena za jeden deň (8:00-17:00)*'];
const roomTableRows = roomRows.map(room => [
  { text: room.name, link: room.link },
  room.floorSize,
  room.capacity,
  room.price
]);

// Prepare catering data for table
const cateringHeaders = ['Obed a občerstvenie', 'Cena za deň'];
const cateringRows = cateringData.map(item => [item.item, item.price]);
---

<BaseLayout
  title={`${t('page.pricing.title')} | ${t('ui.siteName')}`}
  description={t('page.pricing.description')}
  lang={lang}
>
  <div class="pricing-page">
    <h1>{t('page.pricing.title')}</h1>
    <p class="pricing-intro">{t('pricing.intro')}</p>

    <PricingTable
      title={t('pricing.roomRentals')}
      headers={roomHeaders}
      rows={roomTableRows}
    />

    {cateringRows.length > 0 && (
      <div class="catering-section">
        <PricingTable
          title={t('pricing.catering')}
          headers={cateringHeaders}
          rows={cateringRows}
        />
        <p class="catering-note">*Možnosť individuálnej dohody o množstve občerstvenia</p>
      </div>
    )}

    <div class="pricing-disclaimer">
      <p>Všetky ceny sú uvedené bez DPH.</p>
      <p>* Cena za jeden deň platí v čase od 8:00 do 17:00 hod.<br />
      V prípade záujmu o využitie miestnosti v inom čase je možná individuálna dohoda.</p>
      <p class="pricing-year">Cenník platí pre rok 2025.</p>
    </div>
  </div>
</BaseLayout>

<style>
  .pricing-page {
    max-width: 900px;
    margin: 0 auto;
  }

  .pricing-intro {
    margin-bottom: 2rem;
    color: var(--color-text-light);
    font-size: 1.1rem;
  }

  .pricing-disclaimer {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--color-background-alt);
    border-radius: 4px;
    font-size: 0.9rem;
    color: var(--color-text-light);
  }

  .pricing-disclaimer p {
    margin-bottom: 0.75rem;
  }

  .pricing-disclaimer p:last-child {
    margin-bottom: 0;
  }

  .pricing-year {
    font-weight: 600;
    color: var(--color-text);
  }

  .catering-note {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--color-text-light);
    font-style: italic;
  }
</style>
